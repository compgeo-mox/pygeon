import numpy as np
import pytest

import pygeon as pg


@pytest.fixture
def discr():
    return pg.RT1("test")


def test_ndof(discr, unit_sd):
    assert discr.ndof(unit_sd) == unit_sd.dim * (unit_sd.num_faces + unit_sd.num_cells)


def test_asssemble_mass_matrix(discr, ref_sd):
    M = discr.assemble_mass_matrix(ref_sd)

    match ref_sd.dim:
        case 1:
            M_known = (
                np.array(
                    [
                        [8, -2, 1],
                        [-2, 8, 1],
                        [1, 1, 2],
                    ]
                )
                / 60
            )
        case 2:
            M_known = (
                np.array(
                    [
                        [10, -2, 1, 2, -1, 5, 0, -2],
                        [-2, 16, 4, -1, 5, -4, 0, 1],
                        [1, 4, 16, 2, -4, 5, 0, 1],
                        [2, -1, 2, 10, -5, 1, 0, 2],
                        [-1, 5, -4, -5, 22, -8, -3, -1],
                        [5, -4, 5, 1, -8, 22, 3, -4],
                        [0, 0, 0, 0, -3, 3, 4, -2],
                        [-2, 1, 1, 2, -1, -4, -2, 8],
                    ]
                )
                / 360
            )
        case 3:
            M_known = (
                np.array(
                    [
                        [24, -4, 1, -1, 6, -3, 11, -11, 6, -3, 0, 0, -2, -6, 4],
                        [-4, 52, 8, -8, -1, 18, -10, 10, -1, 18, 0, 0, -2, 8, -3],
                        [1, 8, 52, 8, 4, -10, 18, 0, 1, 0, 18, -10, 2, 3, -8],
                        [-1, -8, 8, 52, -1, 0, 0, 18, -4, 10, -10, 18, -2, -3, -3],
                        [6, -1, 4, -1, 24, -11, 3, 0, 6, 0, 3, -11, -2, 4, -6],
                        [-3, 18, -10, 0, -11, 64, -20, 10, 0, 18, -10, 4, -7, 4, 10],
                        [11, -10, 18, 0, 3, -20, 64, -4, 0, -10, 18, -10, 7, -10, -4],
                        [-11, 10, 0, 18, 0, 10, -4, 64, -3, 20, -10, 18, -7, 10, -7],
                        [6, -1, 1, -4, 6, 0, 0, -3, 24, -11, 11, -3, -2, 4, 4],
                        [-3, 18, 0, 10, 0, 18, -10, 20, -11, 64, -4, 10, -7, 4, -7],
                        [0, 0, 18, -10, 3, -10, 18, -10, 11, -4, 64, -20, 7, 7, -4],
                        [0, 0, -10, 18, -11, 4, -10, 18, -3, 10, -20, 64, -7, -7, 10],
                        [-2, -2, 2, -2, -2, -7, 7, -7, -2, -7, 7, -7, 12, -4, -4],
                        [-6, 8, 3, -3, 4, 4, -10, 10, 4, 4, 7, -7, -4, 32, -14],
                        [4, -3, -8, -3, -6, 10, -4, -7, 4, -7, -4, 10, -4, -14, 32],
                    ]
                )
                / 1260
            )

    assert np.allclose(M.todense(), M_known)


def test_range_discr_class(discr):
    assert discr.get_range_discr_class(2) is pg.PwLinears
