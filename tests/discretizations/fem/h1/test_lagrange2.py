"""Module contains a unit test for the Lagrangean P2 discretization."""

import numpy as np
import pytest

import pygeon as pg


@pytest.fixture
def discr():
    return pg.Lagrange2("test")


def test_ndof(discr, unit_sd):
    match unit_sd.dim:
        case 1:
            num_edges = unit_sd.num_cells
        case 2:
            num_edges = unit_sd.num_faces
        case 3:
            num_edges = unit_sd.num_ridges

    assert discr.ndof(unit_sd) == unit_sd.num_nodes + num_edges


def test_assemble_mass_matrix(discr, ref_sd):
    M = discr.assemble_mass_matrix(ref_sd)

    match ref_sd.dim:
        case 1:
            M_known = (
                np.array(
                    [
                        [4, -1, 2],
                        [-1, 4, 2],
                        [2, 2, 16],
                    ]
                )
                / 30
            )

        case 2:
            M_known = (
                np.array(
                    [
                        [6, -1, -1, -4, 0, 0],
                        [-1, 6, -1, 0, -4, 0],
                        [-1, -1, 6, 0, 0, -4],
                        [-4, 0, 0, 32, 16, 16],
                        [0, -4, 0, 16, 32, 16],
                        [0, 0, -4, 16, 16, 32],
                    ]
                )
                / 360
            )
        case 3:
            M_known = (
                np.array(
                    [
                        [6.0, 1.0, 1.0, 1.0, -6.0, -6.0, -4.0, -6.0, -4.0, -4.0],
                        [1.0, 6.0, 1.0, 1.0, -6.0, -4.0, -6.0, -4.0, -6.0, -4.0],
                        [1.0, 1.0, 6.0, 1.0, -4.0, -6.0, -6.0, -4.0, -4.0, -6.0],
                        [1.0, 1.0, 1.0, 6.0, -4.0, -4.0, -4.0, -6.0, -6.0, -6.0],
                        [-6.0, -6.0, -4.0, -4.0, 32.0, 16.0, 16.0, 16.0, 16.0, 8.0],
                        [-6.0, -4.0, -6.0, -4.0, 16.0, 32.0, 16.0, 16.0, 8.0, 16.0],
                        [-4.0, -6.0, -6.0, -4.0, 16.0, 16.0, 32.0, 8.0, 16.0, 16.0],
                        [-6.0, -4.0, -4.0, -6.0, 16.0, 16.0, 8.0, 32.0, 16.0, 16.0],
                        [-4.0, -6.0, -4.0, -6.0, 16.0, 8.0, 16.0, 16.0, 32.0, 16.0],
                        [-4.0, -4.0, -6.0, -6.0, 8.0, 16.0, 16.0, 16.0, 16.0, 32.0],
                    ]
                )
                / 2520
            )

    assert np.allclose(M.todense(), M_known)


def test_assemble_diff_matrix(discr, ref_sd):
    D = discr.assemble_diff_matrix(ref_sd)

    match ref_sd.dim:
        case 1:
            D_known = np.array(
                [
                    [-3.0, -1.0, 4.0],
                    [1.0, 3.0, -4.0],
                ]
            )

        case 2:
            D_known = np.array(
                [
                    [0.0, -3.0, -1.0, 4.0, 0.0, 0.0],
                    [-3.0, 0.0, -1.0, 0.0, 4.0, 0.0],
                    [-3.0, -1.0, 0.0, 0.0, 0.0, 4.0],
                    [0.0, 1.0, 3.0, -4.0, 0.0, 0.0],
                    [1.0, 0.0, 3.0, 0.0, -4.0, 0.0],
                    [1.0, 3.0, 0.0, 0.0, 0.0, -4.0],
                ]
            )
        case 3:
            D_known = np.array(
                [
                    [-3.0, -1.0, 0.0, 0.0, 4.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                    [-3.0, 0.0, -1.0, 0.0, 0.0, 4.0, 0.0, 0.0, 0.0, 0.0],
                    [-3.0, 0.0, 0.0, -1.0, 0.0, 0.0, 4.0, 0.0, 0.0, 0.0],
                    [0.0, -3.0, -1.0, 0.0, 0.0, 0.0, 0.0, 4.0, 0.0, 0.0],
                    [0.0, -3.0, 0.0, -1.0, 0.0, 0.0, 0.0, 0.0, 4.0, 0.0],
                    [0.0, 0.0, -3.0, -1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 4.0],
                    [-1.0, -3.0, 0.0, 0.0, 4.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                    [-1.0, 0.0, -3.0, 0.0, 0.0, 4.0, 0.0, 0.0, 0.0, 0.0],
                    [-1.0, 0.0, 0.0, -3.0, 0.0, 0.0, 4.0, 0.0, 0.0, 0.0],
                    [0.0, -1.0, -3.0, 0.0, 0.0, 0.0, 0.0, 4.0, 0.0, 0.0],
                    [0.0, -1.0, 0.0, -3.0, 0.0, 0.0, 0.0, 0.0, 4.0, 0.0],
                    [0.0, 0.0, -1.0, -3.0, 0.0, 0.0, 0.0, 0.0, 0.0, 4.0],
                ]
            )

    assert np.allclose(D.todense(), D_known)


def test_assemble_stiff_matrix(discr, ref_sd):
    M = discr.assemble_stiff_matrix(ref_sd)

    match ref_sd.dim:
        case 1:
            M_known = (
                np.array(
                    [
                        [14.0, 2.0, -16.0],
                        [2.0, 14.0, -16.0],
                        [-16.0, -16.0, 32.0],
                    ]
                )
                / 6
            )

        case 2:
            M_known = (
                np.array(
                    [
                        [6.0, 1.0, 1.0, 0.0, -4.0, -4.0],
                        [1.0, 3.0, 0.0, 0.0, 0.0, -4.0],
                        [1.0, 0.0, 3.0, 0.0, -4.0, 0.0],
                        [0.0, 0.0, 0.0, 16.0, -8.0, -8.0],
                        [-4.0, 0.0, -4.0, -8.0, 16.0, 0.0],
                        [-4.0, -4.0, 0.0, -8.0, 0.0, 16.0],
                    ]
                )
                / 6
            )
        case 3:
            M_known = (
                np.array(
                    [
                        [9.0, 1.0, 1.0, 1.0, 2.0, 2.0, -6.0, 2.0, -6.0, -6.0],
                        [1.0, 3.0, 0.0, 0.0, 0.0, -1.0, 1.0, -1.0, 1.0, -4.0],
                        [1.0, 0.0, 3.0, 0.0, -1.0, 0.0, 1.0, -1.0, -4.0, 1.0],
                        [1.0, 0.0, 0.0, 3.0, -1.0, -1.0, -4.0, 0.0, 1.0, 1.0],
                        [2.0, 0.0, -1.0, -1.0, 16.0, 4.0, -8.0, 4.0, -8.0, -8.0],
                        [2.0, -1.0, 0.0, -1.0, 4.0, 16.0, -8.0, 4.0, -8.0, -8.0],
                        [-6.0, 1.0, 1.0, -4.0, -8.0, -8.0, 24.0, -8.0, 4.0, 4.0],
                        [2.0, -1.0, -1.0, 0.0, 4.0, 4.0, -8.0, 16.0, -8.0, -8.0],
                        [-6.0, 1.0, -4.0, 1.0, -8.0, -8.0, 4.0, -8.0, 24.0, 4.0],
                        [-6.0, -4.0, 1.0, 1.0, -8.0, -8.0, 4.0, -8.0, 4.0, 24.0],
                    ]
                )
                / 30
            )

    assert np.allclose(M.todense(), M_known)


def test_range_discr(discr):
    assert discr.get_range_discr_class(1) is pg.PwLinears
    assert discr.get_range_discr_class(2) is pg.BDM1
    assert discr.get_range_discr_class(3) is pg.Nedelec1
